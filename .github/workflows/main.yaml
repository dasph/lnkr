name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy

    runs-on: ubuntu-latest

    permissions:
      contents: 'read|write'
      id-token: 'write'

    steps:
    - name: Checkout 🛎️
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud 🔑
      uses: google-github-actions/auth@v1.1.0
      with:
        credentials_json: '${{ secrets.GOOGLE }}'

    - name: Authenticate to Google Artifact Registry 🔑
      uses: docker/login-action@v2.1.0
      with:
        registry: ${{ vars.LOCATION }}-docker.pkg.dev
        username: _json_key
        password: ${{ secrets.GOOGLE }}

    - name: Build and Push Container 🏗️
      run: |-
        docker build -t "${{ vars.LOCATION }}-docker.pkg.dev/${{ vars.PROJECT }}/${{ vars.REPOSITORY }}/${{ vars.SERVICE }}:${{ github.sha }}" ./
        docker push "${{ vars.LOCATION }}-docker.pkg.dev/${{ vars.PROJECT }}/${{ vars.REPOSITORY }}/${{ vars.SERVICE }}:${{ github.sha }}"

    - name: Deploy to App Engine 🚀
      uses: google-github-actions/deploy-appengine@v1
      with:
        image_url: ${{ vars.LOCATION }}-docker.pkg.dev/${{ vars.PROJECT }}/${{ vars.REPOSITORY }}/${{ vars.SERVICE }}:${{ github.sha }}
        env_vars: |
          FIREBASE=${{ secrets.FIREBASE }}
